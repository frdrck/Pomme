function choice(a){return a[Math.floor(Math.random()*a.length)]}function keys(a){var b=[];for(var c in a)b.push(c);return b}function shuffle(a){var b,c,d;for(b=1;b<a.length;b++){c=Math.floor(Math.random()*(1+b));if(c!=b){d=a[b];a[b]=a[c];a[c]=d}}}function scrollToBottom(a){try{$(a).scrollTop($(a)[0].scrollHeight)}catch(b){}}function prepare_url(a){a=trim(a);if(a.indexOf("javascript")===0)return"";if(a.indexOf("http")!==0)return"http://"+a;return a}function sanitize(a){return a.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/\"/g,""")}function trim(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")}BASE_URL="http://pomme.us:32123";var API={URL:{list:BASE_URL+"/game/list",active:BASE_URL+"/game/active",newgame:BASE_URL+"/game/newgame",create:BASE_URL+"/game/new",edit:BASE_URL+"/game/edit",view:BASE_URL+"/game/view",join:BASE_URL+"/game/join",join:BASE_URL+"/game/join",poll:BASE_URL+"/game/poll",send:BASE_URL+"/game/send",bet:BASE_URL+"/game/bet",judge:BASE_URL+"/game/judge",vote:BASE_URL+"/game/vote",skip:BASE_URL+"/game/skip",rejoin:BASE_URL+"/game/rejoin",pass:BASE_URL+"/game/pass",restart:BASE_URL+"/game/restart",deal:BASE_URL+"/game/deal",login:BASE_URL+"/user/login",checkin:BASE_URL+"/game/list",user_view:BASE_URL+"/user/view",user_edit:BASE_URL+"/user/edit",combo_user:BASE_URL+"/combo/user",combo_judge:BASE_URL+"/combo/judge",combo_game:BASE_URL+"/combo/game",like_add:BASE_URL+"/like/add",like_remove:BASE_URL+"/like/remove",pomme_count:BASE_URL+"/pomme/count"},is_safari:navigator.appVersion.indexOf("Safari")!==-1&&navigator.appVersion.indexOf("Chrome")===-1};NUMBERS="none one two three four five six seven eight nine ten eleven twelve thirteen fourteen fifteen sixteen seventeen eighteen nineteen twenty twenty-one twenty-two twenty-three twenty-four twenty-five twenty-six twenty-seven twenty-eight twenty-nine thirty".split(" ");ILLEGAL_SNARK=["That's not your name!","You don't want people really calling you that, do you?","I highly doubt that's your name","Maybe people do really call you that..","Try a name that won't make your mother cry"];STATE_IDLE=0;STATE_SETUP=1;STATE_BET=2;STATE_PICKED=3;STATE_JUDGE=4;STATE_VOTE=5;STATE_WIN=6;STATE_GAMEOVER=7;$(function(){$("#howto-close").click(function(){$("#howto").fadeOut(500)});$("#howto a").click(function(){$("#howto iframe").show();$("#howto a").hide();return false})});var Preload={queue:[],lookup:{main:{},player:{}},timeout:false,enqueue:function(a,b){for(var c=0;c<b.length;c++){if(b[c]in Preload.lookup[a])continue;Preload.lookup[a][b[c]]=true;var d=Preload.queue.length;Preload.queue[d]=new Image;Preload.queue[d].src="/img/"+a+"/"+b[c]}if(Preload.timeout===false)Preload.checkQueue()},checkQueue:function(){var a=0;for(var b=0;b<Preload.queue.length;b++){if(Preload.queue[b].complete)a+=1}if(a===Preload.queue.length){Preload.queue=[];Preload.timeout=false}else{Preload.timeout=setTimeout(Preload.checkQueue,500)}}};var nullplayer={play:function(){},stop:function(){}};var Sound={new_player:nullplayer,new_round:nullplayer,click:nullplayer,ticking:nullplayer,chat:nullplayer,wongame:nullplayer,init:function(){Sound.new_player=soundManager.createSound({id:"newplayer",url:"/mp3/newplayer.mp3",volume:100});Sound.new_round=soundManager.createSound({id:"new_round",url:"/mp3/newround4.mp3",volume:100});Sound.click=soundManager.createSound({id:"click",url:"/mp3/click.mp3",volume:100,multiShot:false});Sound.ticking=soundManager.createSound({id:"ticking",url:"/mp3/10secondtick_fadein.mp3",volume:100});Sound.chat=soundManager.createSound({id:"chat",url:"/mp3/chat1.mp3",volume:100});Sound.wonround=soundManager.createSound({id:"wonround",url:"/mp3/roundwin.mp3",volume:100});Sound.wongame=soundManager.createSound({id:"wongame",url:"/mp3/won.mp3",volume:100});$("#mute").bind("click",Sound.mute)},muted:false,mute:function(){if(self.muted){$("#mute").html("Mute");$("#mute").removeClass("muted");soundManager.unmute();self.muted=false}else{$("#mute").html("Unmute");$("#mute").addClass("muted");soundManager.mute();self.muted=true}}};soundManager.onready(Sound.init);var Auth={session:false,username:false,login:function(){var a=$("#login-name").val().replace(/\W+/g,"");if(!a.length)return;if(a==="false"||a==="None"){alert("Pick a different name dude sorry");return}Auth.username=a;$("#login-altname").html(a);var b={name:a};$.post(API.URL.login,b,Auth.loginCheck,"json")},loginCheck:function(a){if(a&&"error"in a){if(a.error==="password")return Auth.passwordForm();if(a.error==="bad_password"){$("#password-error").html("Wrong password, try again");return Auth.passwordForm()}if(a.error==="illegal"){alert(choice(ILLEGAL_SNARK));return}alert(a.error);return}Auth.session=a.session;document.cookie="session="+Auth.session+";path=/;domain=.pomme.us;max-age=1086400";Auth.unload();Auth.loginCallback()},passwordForm:function(){Auth.currentForm=Auth.passwordClick;$("#login-password").val("");$("#login-info").hide();$("#password-info").show();$("#login-password").focus()},checkin:function(){var a={session:Auth.session};$.post(API.URL.checkin,a,Auth.checkinCallback,"json")},checkinCallback:function(a){Auth.username=a["username"];Auth.loginCallback()},passwordClick:function(){var a=$("#login-password").val();a=$.md5("pomme"+a);var b={name:Auth.username,password:a};$.post(API.URL.login,b,Auth.loginCheck,"json")},loginCallback:function(){},logout:function(){document.cookie="session=false;path=/;domain=.pomme.us;max-age=0";Auth.username=false;Auth.session=false;Auth.logoutCallback();Auth.load()},logoutCallback:function(){},unload:function(){$("#login").hide();$("#login-name").val("");$("#login-password").val("")},reset:function(){Auth.unload();Auth.load();return false},currentForm:function(){},keys:function(a){if(a.keyCode===13)Auth.currentForm()},load:function(){$("#loading").hide();Auth.currentForm=Auth.login;$("#login-name").val("");$("#login-password").val("");$("#login-info").show();$("#password-info").hide();$("#login").show();$("#login-name").focus()},init:function(){Auth.currentForm=Auth.login;$("#login-name").bind("keydown",Auth.keys);$("#login-password").bind("keydown",Auth.keys);$("#login-go").bind("click",Auth.login);$("#login-back").bind("click",Auth.reset);$("#password-go").bind("click",Auth.passwordClick);$("#credits").bind("click",function(){$("#credits_box,#credits_curtain").fadeIn(500)});$("#credits_curtain,#credits_close").bind("click",function(){$("#credits_box,#credits_curtain").fadeOut(500)});if(document.cookie){var a=document.cookie.split(";");for(i in a){var b=a[i].split("=");if(b[0].indexOf("session")!==-1){if(b[1]!=="false"&&b[1]!=="undefined"){Auth.session=b[1];break}}}if(Auth.session)return true}return false}};var Chat={seen:{},sendCount:-1,height:300,badwords:"nigg faggot n1gg".split(" "),keys:function(a){switch(a.keyCode){case 13:Chat.send();break;case 33:var b=$("#chat_container").scrollTop()-Chat.height+20;$("#chat_container").scrollTop(b);break;case 34:var b=$("#chat_container").scrollTop()+Chat.height+20;$("#chat_container").scrollTop(b);break}},send:function(){var a=$("#chat-message").val();$("#chat-message").val("");if(!a)return;var b=a.toLowerCase();for(i in Chat.badwords){if(b.indexOf(Chat.badwords[i])!==-1)return alert("BE NICE :(")}Sound.chat.play();Chat.sendCount-=1;var c=$.md5(a);Chat.seen[c]=true;var d="<p><span class='user you'>"+Auth.username+"</span><span class='msg'>"+Chat.parse(a)+"</span></p>";$("#chat").append(d);scrollToBottom("#chat_container");var e={session:Auth.session,game:Game.name,msg:a};$.post(API.URL.send,e)},parse:function(a){if(!a)return"";if(a.indexOf("http")!==-1){var b=sanitize(a).split(" ");var c=[];for(var d=0;d<b.length;d++){if(b[d].indexOf("http")===0){if(b[d].indexOf("gif")!==-1||b[d].indexOf("jpg")!==-1||b[d].indexOf("png")!==-1||b[d].indexOf("jpeg")!==-1||b[d].indexOf("GIF")!==-1||b[d].indexOf("JPG")!==-1||b[d].indexOf("PNG")!==-1||b[d].indexOf("JPEG")!==-1)c.push("<img src='"+b[d]+"'>");else c.push("<a href='"+b[d]+"' target='_blank'>"+b[d]+"</a>")}else c.push(b[d])}return c.join(" ")}return sanitize(a)},add:function(a){if(!a)return;if(!a.length)return;var b=[];var c=false;for(var d=0;d<a.length;d++){var e=a[d];if(e[0]in Chat.seen)continue;if(e[2]===Auth.username){var f=$.md5(e[3]);if(f in Chat.seen)continue;b.push("<p><span class='user you'>"+e[2]+"</span><span class='msg'>"+sanitize(e[3])+"</span></p>")}else if(e[2]in Game.ignoreList)continue;else if(e[2]==="frederick")b.push("<p><span class='user'>"+e[2]+"</span><span class='msg'>"+Chat.parse(e[3])+"</span></p>");else b.push("<p><span class='user'>"+e[2]+"</span><span class='msg'>"+sanitize(e[3])+"</span></p>");Chat.seen[e[0]]=true;if(e[3].indexOf("http")!==-1)c=true}if(b.length){$("#chat").append(b.join(""));scrollToBottom("#chat_container");if(c){setTimeout('scrollToBottom("#chat_container")',200);setTimeout('scrollToBottom("#chat_container")',500);setTimeout('scrollToBottom("#chat_container")',1e3);if(b.length>10)setTimeout('scrollToBottom("#chat_container")',2e3)}}}};var Game={last:0,name:"lobbychat",ignoreList:{},join:function(){var a={session:Auth.session,last:Game.last,game:Game.name};$.post(API.URL.join,a,Game.joinCallback,"json").error(Game.joinError)},joinCallback:function(a){if(!a)return Game.joinError();if(Auth.username===false)Auth.username=a["username"];if("error"in a)return Game.pollError();document.cookie="session="+Auth.session+";path=/;domain=.pomme.us;max-age=1086400";Game.last=a["last"];Game.score=a["score"];if(Game.score<5)$("#profile_triangle,#profile_welcome").hide();Chat.add(a["chat"]);self.timeout=setTimeout(Game.poll,1e4)},poll:function(){if(Auth.session===false)return;var a={session:Auth.session,last:Game.last,game:Game.name};$.post(API.URL.poll,a,Game.pollCallback,"json").error(Game.pollError)},joinError:function(){self.timeout=setTimeout(Game.join,5e3)},pollError:function(){self.timeout=setTimeout(Game.poll,5e3)},pollCallback:function(a){if(!a)return Game.pollError();if("error"in a)return Game.pollError();Chat.add(a["chat"]);Game.last=a["last"];self.timeout=setTimeout(Game.poll,1e3)}};var Active={mouseIn:function(){$("#chat_active_list").fadeIn(200)},mouseOut:function(){$("#chat_active_list").fadeOut(200)},poll:function(){$.post(API.URL.pomme_count,{},Active.pollCallback,"json")},pollCallback:function(a){$("#chat_active").addClass("active");$("#chat_count").html(a["count"]);setTimeout(Active.poll,1e4)},update:function(a){if(a["players"].length>1)$("#chat_active").addClass("active");else $("#chat_active").removeClass("active");$("#chat_count").html(a["players"].length);var b=[];for(i in a["players"])b.push(a["players"][i].name);$("#chat_active_list").html(b.sort().join("<br/>"))},init:function(){$("#chat_active_container").hover(Active.mouseIn,Active.mouseOut)}};var Newgame={keys:function(a){var b=a.keyCode;if(b===13){Newgame.start()}setTimeout(Newgame.dispurl,200)},dispurl:function(){$("#newgame-url").html(Newgame.urlgen($("#newgame-name").val()))},urlgen:function(a){return a.replace(/[^A-Za-z0-9]/g,"")},privateToggle:function(){$("#newgame-password-container").toggle()},start:function(){var a={name:$("#newgame-name").val(),capacity:$("#newgame-capacity :selected").val(),goal:$("#newgame-goal :selected").val(),timer:$("#newgame-timer :selected").val(),"private":$("#newgame-private:checked").val()!==undefined?"1":"0",password:$("#newgame-password").val(),session:Auth.session};if(a.name.length<1){alert("You must specify a name for the room");return}$.post(API.URL.create,a,Newgame.success,"json")},success:function(a){if(a&&"error"in a){var b={empty:"Please give a name for the room",url:"Plz name the room something that can be a url (add letters, numbers)",ip:"Someone is already logged in with this name",illegal:choice(ILLEGAL_SNARK)};if(a.error in b)alert(b[a.error]);else if(a.error==="dupe"){}else alert("TRY AGAIN");return}var c=a.path;document.location="http://pomme.us/"+c},unload:function(){$("#newgame-curtain, #newgame").fadeOut(500)},load:function(){$.post(API.URL.newgame,{session:Auth.session},Newgame.success,"json")},init:function(){$("#newgame-curtain").bind("click",Newgame.unload);$("#newgame-open").bind("click",Newgame.load);$("#newgame-name").bind("keydown",Newgame.keys);$("#newgame-go").bind("click",Newgame.start);$("#newgame-private").bind("click",Newgame.privateToggle)}};var Slideshow={height:250,width:250,index:0,timer:false,combos:[["1279213983813-dumpfm-noisia-slimer-at-the-door.gif","1279235222382-dumpfm-neue-slimer_walk.gif","mint milano","hmoob"],["chairsta.gif","gun-guy.gif","deanna","fred"]],preload:function(){var a={player:[],main:[]};if(Slideshow.combos.length>1){Preload.enqueue("player",[Slideshow.combos[0][0]]);Preload.enqueue("main",[Slideshow.combos[0][1]]);Preload.enqueue("player",[Slideshow.combos[1][0]]);Preload.enqueue("main",[Slideshow.combos[1][1]])}for(var b=2;b<Slideshow.combos.length;b++){a["player"].push(Slideshow.combos[b][0]);a["main"].push(Slideshow.combos[b][1])}Preload.enqueue("player",a["player"]);Preload.enqueue("main",a["main"])},lastimage:"",load:function(){$("#combo-wrapper").animate({left:$(window).width()*2},2e3,function(){s="<img src='/img/player/"+Slideshow.combos[Slideshow.index][0]+"' style='margin-right: 10px'/>";s+="<img src='/img/main/"+Slideshow.combos[Slideshow.index][1]+"'/>";Slideshow.index=Math.floor(Math.random()*Slideshow.combos.length);$("#combo").html(s);$("#combo-wrapper").css({left:-2*$("#combo-wrapper").width()});setTimeout(Slideshow.draw,10)})},draw:function(){var a=30;$("#combo-wrapper").animate({left:a},2e3,function(){Slideshow.timer=setTimeout(Slideshow.load,5e3)})},center:function(){var a=$("#combo").width()*-1/2;$("#combo-wrapper").animate({"margin-left":a},200)},stop:function(){clearTimeout(Slideshow.timer)},init:function(a){if(a.length){Slideshow.combos=a;Slideshow.index=a.length-1}$("#combo-wrapper").css({opacity:1});setTimeout(Slideshow.preload,2e3)}};var Lobby={games:{},unload:function(){$("#lobby").hide();Slideshow.stop();Auth.load()},load:function(){$("#loading").fadeIn(100);var a={session:Auth.session};$.post(API.URL.list,a,Lobby.loadCallback,"json")},loadCallback:function(a){if(a.error){return Auth.logout()}Auth.username=a["username"];$("#score").html(a["score"]);$("#profile-username").html(Auth.username);Lobby.games=a["games"];var b=Lobby.gamesBox();if(b)Lobby.manifestUpdatePath(b);$("#joingame-open").click(Lobby.autojoin);Slideshow.init(a["combos"]);Slideshow.load();Active.poll();Game.join();$("#chat-message").bind("keydown",Chat.keys);$("#loading").fadeOut(200);$("#lobby").fadeIn(500);$("#profile").click(Lobby.redirect_to_profile)},room_to_autojoin:"bigapple",autojoin:function(){clearTimeout(Game.timeout);$("#loading").show();$("#lobby").fadeOut(200);$.post(API.URL.active,{session:Auth.session},Lobby.autojoinCallback,"json")},autojoinCallback:function(a){document.location="http://pomme.us/"+a["path"]},redirect_to_profile:function(){document.location="http://pomme.us/profile/"+Auth.username},reload:function(){var a={session:Auth.session};$.post(API.URL.list,a,Lobby.reloadCallback,"json")},reloadCallback:function(a){if("error"in a)return Lobby.reloadDelay();if(console)console.log("RELOADING");Lobby.games=a["games"];Lobby.gamesBox();Slideshow.combos=a["combos"];Slideshow.preload();setTimeout(Lobby.reload,3e4)},reloadDelay:function(){setTimeout(Lobby.reload,3e4)},gamesBox:function(){var a=[];var b=[];var c="bigapple";var d=0;for(key in Lobby.games)a.push(key);a=a.sort();b.push(Lobby.gameRow(Lobby.games["bigapple"]));for(var e=0;e<a.length;e++){var f=Lobby.games[a[e]];if(f.players.length<1)continue;if(f.private)continue;if(a[e]==="lobbychat")continue;if(c==="bigapple"||f.players.length>d&&f.players.length!==f.capacity){c=a[e];d=f.players.length}if(a[e]==="bigapple")continue;b.push(Lobby.gameRow(f))}if(b.length<2){if(!(c in Lobby.games)||Lobby.games[c].players.length<4)document.location="http://pomme.us/"+c}$("#game-list").html(b.join(""));return c},gameRow:function(a){if(typeof a==="undefined")return"";var b="<li data-path='"+a.path+"'";if(a.players.length>=a.capacity)b+=" class='full'";else if(a.private)b+=" class='private'";b+=">";b+="<span class='name'>"+a.name+"</span>";if(a.players.length>=a.capacity)b+="<span class='size'>FULL</span>";else if(a.private===1)b+="<span class='size'>PRIVATE</span>";else b+="<span class='size'>"+a.players.length+" / "+a.capacity+"</span>";b+="</li>";return b},manifestUpdate:function(){var a=$(this).data("path");Lobby.manifestUpdatePath(a)},joinClick:function(){var a=$(this).data("path");if(Lobby.games[a].private)return;document.location="http://pomme.us/"+a},manifestUpdatePath:function(a){var b=Lobby.games[a];if(b.players.length>=b.capacity){$("#game-manifest span.full").show();$("#game-manifest span.private").hide()}else if(b.private){$("#game-manifest span.full").hide();$("#game-manifest span.private").show()}else{$("#game-manifest span.full").hide();$("#game-manifest span.private").hide()}$("#game-name").html(b.name);var c=[];var d={};for(var e=0;e<b.players.length;e++){var f="<li>";f+="<span class='name'>"+b.players[e].name+"</span>";f+="<span class='score'>"+b.players[e].score+"</span>";f+="</li>";if(!(b.players[e].score in d))d[b.players[e].score]=[];d[b.players[e].score].push(f)}var g=keys(d).sort().reverse();for(var e in g)c.push(d[g[e]].join(""));$("#game-occupants").html(c.join(""))},init:function(){$("#game-list li").live("mouseover",Lobby.manifestUpdate);$("#game-list li").live("click",Lobby.joinClick);Active.init()}};var Main={focus:function(){$.fx.off=true;$.fx.off=false},resize:function(){var a=$(window).width();var b=$(window).height();var c=10;var d=20;var e=b-100-250-40;var f=e-70;var g=250;var h=280;var i=h+5;var j=310;var k=b-j+30;$("#chat_active_container").css({top:20,left:340});$("#chat_active_list").css({top:20,left:340});$("#chat_container").css({bottom:k,left:0,height:j,width:a+20*c});$("#chat_bg").css({bottom:k-d-7,left:0,height:b-k+d+15,width:i+5,opacity:.8});$("#chat_shim").css({height:b-k/2});$("#chat").css({width:i-15});$("#form").css({top:j-2-32,left:8,width:i-15,height:d,"padding-right":"+= 10","padding-bottom":15});$("#games").css({height:b-100});$("#game-manifest").css({height:f});$("#combo-wrapper").css({bottom:50});scrollToBottom("#chat_container")},init:function(){$(window).bind("resize",Main.resize);$(window).bind("focus",Main.focus);$("#logout").bind("click",Auth.logout);Main.resize();Lobby.init();Newgame.init();Auth.loginCallback=Lobby.load;Auth.logoutCallback=Lobby.unload;if(Auth.init())Lobby.load();else Auth.load()}};Main.init()
